---
title: '[AWS] - L√†m Sao Tri·ªÉn Khai `Realworld Spring Boot App` tr√™n AWS ECS th√¥ng qua CodeBuild v√† CodePipeline?'
date: '2025-05-16'
lastmod: '2024-05-16'
tags: ['AWS', 'ECS', 'Code-Build', 'Code-Pipeline', 'cloud']
draft: false
summary: Trong b√†i vi·∫øt n√†y, m√¨nh s·∫Ω c√πng anh em t√¨m hi·ªÉu c√°ch tri·ªÉn khai ·ª©ng d·ª•ng Spring Boot l√™n AWS ECS m·ªôt c√°ch t·ª± ƒë·ªông th√¥ng qua CodeBuild v√† CodePipeline. ƒê√¢y l√† flow CI/CD ƒë∆°n gi·∫£n gi√∫p ch√∫ng ta d·ªÖ d√†ng ki·ªÉm so√°t qu√° tr√¨nh build, test v√† deploy, ƒë·ªìng th·ªùi t·ªëi ∆∞u h√≥a hi·ªáu su·∫•t vi·ªác tri·ªÉn khai code tr√™n n·ªÅn t·∫£ng AWS.
images: ['/static/img/cover/posts/ecs.png']
layout: PostLayout
---

<TOCInline toc={props.toc} asDisclosure toHeading={3} />

# 1. - Ch√∫ng ta s·∫Ω l√†m g√¨?

=> Khi m√¨nh Google search th·ª≠ c√°c b√†i h∆∞·ªõng d·∫´n c·∫•u h√¨nh tri·ªÉn khai ·ª©ng d·ª•ng Spring tr√™n m√¥i tr∆∞·ªùng AWS th√¨ ph·∫ßn l·ªõn c√°c b√†i vi·∫øt ƒë·ªÅu l√† nh·ªØng b√†i demo, t·ª©c l√† ch·ªâ deploy m·ªôt ·ª©ng d·ª•ng ƒë∆°n thu·∫ßn (kh√¥ng c√≥ k·∫øt n·ªëi t·ªõi database, kh√¥ng c√≥ c·∫•u h√¨nh).

=> C√¢u h·ªèi l√†, trong th·ª±c t·∫ø c√°c ·ª©ng d·ª•ng Spring n·∫øu ƒë∆∞·ª£c tri·ªÉn khai l√™n m√¥i tr∆∞·ªùng AWS s·∫Ω nh∆∞ th·∫ø n√†o? C√≥ nh·ªØng c√°ch th·ª©c n√†o? L√†m sao ƒë·∫£m b·∫£o k·∫øt n·ªëi t·ª´ ·ª©ng d·ª•ng t·ªõi database, hay l√†m sao b·∫£o v·ªá ƒë∆∞·ª£c c√°c th√¥ng tin c·∫•u h√¨nh nh·∫°y c·∫£m?

<p align="center">
  <img src="/static/img/posts/aws-cicd/image_1.png" alt="Alt text" title="image" />
</p>

Flow ƒë∆°n gi·∫£n b√™n tr√™n m√¥ t·∫£ c√°ch ch·∫°y m·ªôt ·ª©ng d·ª•ng Spring d∆∞·ªõi d·∫°ng Docker container tr√™n m√¥i tr∆∞·ªùng AWS cloud th√¥ng qua ECS v√† ECR.

Th·ª±c t·∫ø, c√≥ nhi·ªÅu c√°ch ƒë·ªÉ ch·∫°y m·ªôt ·ª©ng Spring, v√≠ d·ª•:

- Ch·∫°y tr∆∞c ti·∫øp l·ªánh `java -jar <app-name>.jar`.
- Ch·∫°y th√¥ng qua c√°c web server nh∆∞ [Tomcat](https://tomcat.apache.org/), [Jetty](https://jetty.org/index.html), [GlassFish](https://glassfish.org/).
- Ch·∫°y d∆∞·ªõi d·∫°ng Docker containers.

üëâ B√†i vi·∫øt n√†y, m√¨nh s·∫Ω c√πng anh em t·∫≠p trung v√†o c√°ch s·ªë 3 v√† c·ª• th·ªÉ l√† l√†m sao ƒë·ªÉ `AUTOMATICALLY` `BUILD` v√† `DEPLOY` m·ªôt ·ª©ng d·ª•ng Spring Boot th·ª±c t·∫ø l√™n m√¥i tr∆∞·ªùng AWS th√¥ng qua AWS `RDS`, `CodeBuild`, `CodePipeline`, `Secret Manager`, `ECR`, `ECS`

üëâ To√†n b·ªô flow c·ªßa h·ªá th·ªëng ch√∫ng ta s·∫Ω tri·ªÉn khai trong b√†i vi·∫øt n√†y.

<p align="center">
  <img src="/static/img/posts/aws-cicd/full_flow.png" alt="Alt text" title="image" />
</p>

# 2. - Setup ·ª©ng d·ª•ng Spring Boot

**NOTE**: N·∫øu b·∫°n n√†o mu·ªën t·∫≠p trung v√†o m·ª•c 3 th√¨ c√≥ th·ªÉ tham kh·∫£o source code c·ªßa m√¨nh [t·∫°i ƒë√¢y](https://github.com/canhnd15/aws-cicd)

### 2.1 - ·ª®ng d·ª•ng n√†y l√†m g√¨?

üëâ V·ªÅ nghi·ªáp v·ª•, ƒë√¢y m·ªôt ·ª©ng d·ª•ng Spring Boot ƒë∆°n gi·∫£n, cung c·∫•p c√°c APIs cho m·ªôt h·ªá th·ªëng b√°n kho√° h·ªçc tr·ª±c tuy·∫øn -> m√¨nh t·∫°m g·ªçi l√† `course-service`.

- T·∫°o kho√° h·ªçc m·ªõi: `POST /courses`
- L·∫•y danh s√°ch to√†n b·ªô kho√° h·ªçc: `GET /courses`

### 2.2 - L√†m sao c·∫•u h√¨nh database?

M√¨nh s·ª≠ d·ª•ng Postgres database v√† d·ª±ng lu√¥n tr√™n AWS th√¥ng qua AWS RDS. C·ª• th·ªÉ c√°c b∆∞·ªõc setup m√¨nh s·∫Ω ƒë·ªÅ c·∫≠p ·ªü m·ª•c [3.1](/blog/deploy-spring-boot-application-on-aws-code-build-code-pipeline-ecs#31---d%E1%BB%B1ng-postgres-database-aws-rds)

V·ªÅ ph·∫ßn c·∫•u h√¨nh, c√≥ hai ƒëi·ªÉm c·∫ßn l∆∞u √Ω:

- C√°c th√¥ng tin k·∫øt n·ªëi ƒë·∫øn database ƒë∆∞·ª£c m√¨nh ƒë·ªÉ d∆∞·ªõi d·∫°ng tham s·ªë v√† truy·ªÅn v√†o trong qu√° tr√¨nh runtime ƒë·ªÉ ƒë·∫£m b·∫£o vi·ªác b·∫£o m·∫≠t.

```yml
# ========== Database Configuration ==========
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
```

- S·ª≠ d·ª•ng liquibase ƒë·ªÉ qu·∫£n l√Ω version c√°c update ƒë·ªëi v·ªõi database.

```yml
spring.liquibase.change-log=classpath:/db/liquibase-changelog.xml
```

### 2.3 - L√†m sao build v√† run ·ª©ng d·ª•ng ·ªü local?

Nh∆∞ m√¨nh ƒë√£ ƒë·ªÅ c·∫≠p, ·ª©ng d·ª•ng ƒë∆∞·ª£c tri·ªÉn khai ·ª©ng d·ª•ng d∆∞·ªõi d·∫°ng Docker container -> m√¨nh c√≥ t·∫°o m·ªôt file `Dockerfile` c∆° b·∫£n nh∆∞ sau:

```Dockerfile
FROM openjdk:17

WORKDIR /app

COPY ./target/course-service.jar /app

EXPOSE 8090

CMD ["java", "-jar", "course-service.jar"]
```

- Build ·ª©ng d·ª•ng -> File `.jar`

```shell
mvn clean install -D DB_URL=<database URL> -D DB_USERNAME=<database name> -D DB_PASSWORD=<database password>
```

- Build ·ª©ng d·ª•ng -> Docker image

```shell
docker build -t  course-service:latest .
```

# 3. - Setup AWS

### 3.1 - D·ª±ng Postgres database (AWS RDS)

- Aurora and RDS -> Databases -> Create database -> PostgresSQL

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_2.png" alt="Alt text" title="image" />
</p>

- Free tier and Single-AZ DB instance deployment (1 instance) -> m√¨nh d√πng free tier cho ƒë·ª° m·∫•t ph√≠, con nh√† ngh√®o m√† =))

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_3.png" alt="Alt text" title="image" />
</p>

- anh em nh·∫≠p c√°c th√¥ng tin c·∫•u h√¨nh DB instance identifier, master username, password -> nh·ªõ l∆∞u l·∫°i password anh em nh√©.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_4.png" alt="Alt text" title="image" />
</p>

- Check `Yes` n·∫øu anh em mu·ªën public DB ƒë·ªÉ b√™n ngo√†i internet c√≥ th·ªÉ connect ƒë∆∞·ª£c.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_5.png" alt="Alt text" title="image" />
</p>

- C√°c th√¥ng tin kh√°c anh em c√≥ th·ªÉ ƒë·ªÉ m·∫∑c ƒë·ªãnh.

=> V·∫≠y l√† setup xong database -> anh em c√≥ th·ªÉ v√†o tab `Configuration` ƒë·ªÉ xem l·∫°i c√°c th√¥ng tin c·∫•u h√¨nh.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_6.png" alt="Alt text" title="image" />
</p>

### 3.2 - C·∫•u h√¨nh Secret Manager

- ·ªû m·ª•c 2.2, m√¨nh c√≥ ƒë·ªÅ c·∫≠p ƒë·∫øn vi·ªác c√°c tham s·ªë c·∫•u h√¨nh database s·∫Ω ƒë∆∞·ª£c truy·ªÅn d∆∞·ªõi d·∫°ng tham s·ªë t·∫°i th·ªùi ƒëi·ªÉm runtime. V·∫≠y c√°c th√¥ng tin ƒë√≥ ƒë∆∞·ª£c l∆∞u ·ªü ƒë√¢u?

=> Trong b√†i vi·∫øt n√†y, m√¨nh s·ª≠ d·ª•ng AWS Secret Manager ƒë·ªÉ l∆∞u nh∆∞ sau:

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_2.png" alt="Alt text" title="image" />
</p>

Next ƒë·∫øn step 4 (Review) -> Store

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_3.png" alt="Alt text" title="image" />
</p>

Edit credentials -> th√™m m·ªôt bi·∫øn l√† url tr·ªè ƒë·∫øn database.

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_4.png" alt="Alt text" title="image" />
</p>

### 3.3 - D·ª±ng CodeBuild

- CodeBuild -> Build projects -> Create build project

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_1.png" alt="Alt text" title="image" />
</p>

- Ch·ªçn Source provider -> m√¨nh ch·ªçn GitHub (v√¨ code ƒë·ªÉ tr√™n GitHub). L∆∞u √Ω, n·∫øu c√°c b·∫°n ch∆∞a k·∫øt n·ªëi t·ªõi GitHub bao gi·ªù th√¨ ph·∫£i k·∫øt n·ªëi tr∆∞·ªõc -> Ch·ªçn c√°c option nh∆∞ b√™n d∆∞·ªõi.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_2.png" alt="Alt text" title="image" />
</p>

- `buildspec.yaml` l√† c√°c b∆∞·ªõc ƒë·ªÉ 'h∆∞·ªõng d·∫´n' CodeBuild th·ª±c hi·ªán: build project th√†nh file `.jar` -> build ra Docker image -> ƒë·∫©y Docker image l√™n ECR.

- C√°c b·∫°n c√≥ th·ªÉ Insert build commands -> Switch to editor -> Paste n·ªôi dung file `buildspec.yaml` v√†o (L∆ØU √ù: Ph·∫£i s·ª≠a l·∫°i c√°c th√¥ng tin cho ƒë√∫ng v·ªõi AWS account b·∫°n c·∫•u h√¨nh). Ho·∫∑c check tab `Use a buildspec file` -> s·ª≠ d·ª•ng file `buildpsec.yaml` t·∫°i root folder c·ªßa project lu√¥n.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_3.png" alt="Alt text" title="image" />
</p>

- ƒê·ªÉ CodeBuild c√≥ th·ªÉ pull image t·ª´ ECR v√† ƒë·ªçc c√°c th√¥ng tin c·∫•u h√¨nh database trong file `buildspec.yaml` -> Ch√∫ng ta ph·∫£i c·∫•p quy·ªÅn cho role ƒë∆∞·ª£c t·∫°o nh∆∞ b√™n d∆∞·ªõi.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_4.png" alt="Alt text" title="image" />
</p>

- Add permissioins -> Attach policies -> Search `AmazonEC2ContainerRegistryFullAccess`, `AmazonEC2ContainerRegistryPowerUser`, `SecretsManagerReadWrite`

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_5.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_6.png" alt="Alt text" title="image" />
</p>

- B·∫•m `Start build` -> B·∫Øt ƒë·∫ßu qu√° tr√¨nh build -> Ch·ªù

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_7.png" alt="Alt text" title="image" />
</p>

### 3.4 - D·ª±ng ECR (Elastic Container Registry)

- ECR l√† n∆°i l∆∞u tr·ªØ c√°c images (t∆∞∆°ng t·ª± nh∆∞ DockerHub). ƒê·ªÉ t·∫°o m·ªôt ECR:

Amazon ECR -> Private Registy -> Repository -> Create Repository

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecr_0.png" alt="Alt text" title="image" />
</p>

ƒê·∫∑t t√™n -> ƒê·ªÉ m·∫∑c ƒë·ªãnh c√°c option -> Create

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecr_1.png" alt="Alt text" title="image" />
</p>

### 3.5 - D·ª±ng ECS (cluster, service, task definition)

=> T·∫°o Task Definition:

Amazon Elastic Container Service -> Task definition -> Create new task definition

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_1.png" alt="Alt text" title="image" />
</p>

Ch·ªçn launch type: [AWS Fargate](https://aws.amazon.com/fargate/)

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_2.png" alt="Alt text" title="image" />
</p>

·ªû m·ª•c Task Role -> ch·ªçn ecsTaskExecutionRole

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_4.png" alt="Alt text" title="image" />
</p>

L∆∞u √ù: Do ch√∫ng ta ƒë·ªçc th√¥ng tin c·∫•u h√¨nh t·ª´ Secret Manager -> C√°c b·∫°n attach th√™m policies l√† SecretsManagerReadWrite ƒë·ªÉ task c√≥ quy·ªÅn ƒë·ªçc th√¥ng tin t·ª´ SM.

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_5.png" alt="Alt text" title="image" />
</p>

·ªû m·ª•c Container -> ch·ªçn registry -> ch·ªçn image -> mapping th√™m port 8090 (v√¨ service c·∫•u h√¨nh ch·∫°y ·ªü port 8090)

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_6.png" alt="Alt text" title="image" />
</p>

·ªû ph·∫ßn bi·∫øn m√¥i tr∆∞·ªùng (Environment variables) -> c·∫•u h√¨nh ƒë·ªÉ ƒë·ªçc c√°c th√¥ng tin database t·ª´ Secrets Manager ·ªü m·ª•c 3.2

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_6_1.png" alt="Alt text" title="image" />
</p>

V·∫≠y l√† t·∫°o xong Task definition.

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_7.png" alt="Alt text" title="image" />
</p>

=> T·∫°o Cluster:

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_8.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_9.png" alt="Alt text" title="image" />
</p>

=> T·∫°o Service:

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_10.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_11.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_12.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_13.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_14.png" alt="Alt text" title="image" />
</p>

### 3.6 - D·ª±ng CodePipeline

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_1_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_2.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_3.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_3_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_4.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_5.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_6.png" alt="Alt text" title="image" />
</p>

-> Pipeline build Th√†nh C√¥ng

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_7.png" alt="Alt text" title="image" />
</p>

-> Pipeline build l·∫°i khi c√≥ code update.

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_8.png" alt="Alt text" title="image" />
</p>

# 4. - Testing

Sau khi deploy th√†nh c√¥ng, c√°c b·∫°n truy c·∫≠p v√†o ƒë·ªãa ch·ªâ: `http://<public IP>/swagger-ui/index.html`. Trong ƒë√≥, public IP ch√≠nh l√† ƒë·ªãa ch·ªâ IP public ƒë∆∞·ª£c t·∫°o ra sau khi ch√∫ng t·∫°o task definition th√†nh c√¥ng.

<p align="center">
  <img src="/static/img/posts/aws-cicd/testing_1.png" alt="Alt text" title="image" />
</p>

# 5. - T·ªïng K·∫øt

V·∫≠y l√† trong b√†i vi·∫øt n√†y m√¨nh ƒë√£ c√πng anh em t√¨m hi·ªÉu c√°ch ƒë·ªÉ deloy m·ªôt ·ª©ng d·ª•ng Spring Boot th·ª±c t·∫ø c√≥ k·∫øt n·ªëi ƒë·∫øn database l√™n m√¥i tr∆∞·ªùng Dcoker container th√¥ng qua AWS ECS, ECR. ƒê·ªìng th·ªùi t·ª± ƒë·ªông ho√° vi·ªác build v√† deploy code s·ª≠ d·ª•ng AWS CodeBuild, CodePipeline

H·∫πn g·∫∑p l·∫°i anh em trong c√°c b√†i vi·∫øt ti·∫øp theo. Happy Coding!
