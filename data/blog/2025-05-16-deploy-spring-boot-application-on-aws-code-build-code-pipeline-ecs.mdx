---
title: '[AWS] - LÃ m Sao Triá»ƒn Khai `Realworld Spring Boot App` trÃªn AWS ECS thÃ´ng qua CodeBuild vÃ  CodePipeline?'
date: '2025-05-16'
lastmod: '2024-05-16'
tags: ['AWS', 'ECS', 'Code-Build', 'Code-Pipeline', 'cloud']
draft: false
summary: Trong bÃ i viáº¿t nÃ y, mÃ¬nh sáº½ cÃ¹ng anh em tÃ¬m hiá»ƒu cÃ¡ch triá»ƒn khai á»©ng dá»¥ng Spring Boot lÃªn AWS ECS má»™t cÃ¡ch tá»± Ä‘á»™ng thÃ´ng qua CodeBuild vÃ  CodePipeline. ÄÃ¢y lÃ  flow CI/CD Ä‘Æ¡n giáº£n giÃºp chÃºng ta dá»… dÃ ng kiá»ƒm soÃ¡t quÃ¡ trÃ¬nh build, test vÃ  deploy, Ä‘á»“ng thá»i tá»‘i Æ°u hÃ³a hiá»‡u suáº¥t viá»‡c triá»ƒn khai code trÃªn ná»n táº£ng AWS.
images: ['/static/img/cover/posts/ecs.png']
layout: PostLayout
---

<TOCInline toc={props.toc} asDisclosure toHeading={3} />

# 1. - ChÃºng ta sáº½ lÃ m gÃ¬?

=> Khi mÃ¬nh Google search thá»­ cÃ¡c bÃ i hÆ°á»›ng dáº«n cáº¥u hÃ¬nh triá»ƒn khai á»©ng dá»¥ng Spring trÃªn mÃ´i trÆ°á»ng AWS thÃ¬ pháº§n lá»›n cÃ¡c bÃ i viáº¿t Ä‘á»u lÃ  nhá»¯ng bÃ i demo, tá»©c lÃ  chá»‰ deploy má»™t á»©ng dá»¥ng Ä‘Æ¡n thuáº§n (khÃ´ng cÃ³ káº¿t ná»‘i tá»›i database, khÃ´ng cÃ³ cáº¥u hÃ¬nh).

=> CÃ¢u há»i lÃ , trong thá»±c táº¿ cÃ¡c á»©ng dá»¥ng Spring náº¿u Ä‘Æ°á»£c triá»ƒn khai lÃªn mÃ´i trÆ°á»ng AWS sáº½ nhÆ° tháº¿ nÃ o? CÃ³ nhá»¯ng cÃ¡ch thá»©c nÃ o? LÃ m sao Ä‘áº£m báº£o káº¿t ná»‘i tá»« á»©ng dá»¥ng tá»›i database, hay lÃ m sao báº£o vá»‡ Ä‘Æ°á»£c cÃ¡c thÃ´ng tin cáº¥u hÃ¬nh nháº¡y cáº£m?

<p align="center">
  <img src="/static/img/posts/aws-cicd/image_1.png" alt="Alt text" title="image" />
</p>

Flow Ä‘Æ¡n giáº£n bÃªn trÃªn mÃ´ táº£ cÃ¡ch cháº¡y má»™t á»©ng dá»¥ng Spring dÆ°á»›i dáº¡ng Docker container trÃªn mÃ´i trÆ°á»ng AWS cloud thÃ´ng qua ECS vÃ  ECR.

Thá»±c táº¿, cÃ³ nhiá»u cÃ¡ch Ä‘á»ƒ cháº¡y má»™t á»©ng Spring, vÃ­ dá»¥:

- Cháº¡y trÆ°c tiáº¿p lá»‡nh `java -jar <app-name>.jar`.
- Cháº¡y thÃ´ng qua cÃ¡c web server nhÆ° [Tomcat](https://tomcat.apache.org/), [Jetty](https://jetty.org/index.html), [GlassFish](https://glassfish.org/).
- Cháº¡y dÆ°á»›i dáº¡ng Docker containers.

ğŸ‘‰ BÃ i viáº¿t nÃ y, mÃ¬nh sáº½ cÃ¹ng anh em táº­p trung vÃ o cÃ¡ch sá»‘ 3 vÃ  cá»¥ thá»ƒ lÃ  lÃ m sao Ä‘á»ƒ `AUTOMATICALLY` `BUILD` vÃ  `DEPLOY` má»™t á»©ng dá»¥ng Spring Boot thá»±c táº¿ lÃªn mÃ´i trÆ°á»ng AWS thÃ´ng qua AWS `RDS`, `CodeBuild`, `CodePipeline`, `Secret Manager`, `ECR`, `ECS`

ğŸ‘‰ ToÃ n bá»™ flow cá»§a há»‡ thá»‘ng chÃºng ta sáº½ triá»ƒn khai trong bÃ i viáº¿t nÃ y.

<p align="center">
  <img src="/static/img/posts/aws-cicd/full_flow.png" alt="Alt text" title="image" />
</p>

# 2. - Setup á»©ng dá»¥ng Spring Boot

**NOTE**: Náº¿u báº¡n nÃ o muá»‘n táº­p trung vÃ o má»¥c 3 thÃ¬ cÃ³ thá»ƒ tham kháº£o source code cá»§a mÃ¬nh [táº¡i Ä‘Ã¢y](https://github.com/canhnd15/aws-cicd)

### 2.1 - á»¨ng dá»¥ng nÃ y lÃ m gÃ¬?

ğŸ‘‰ Vá» nghiá»‡p vá»¥, Ä‘Ã¢y má»™t á»©ng dá»¥ng Spring Boot Ä‘Æ¡n giáº£n, cung cáº¥p cÃ¡c APIs cho má»™t há»‡ thá»‘ng bÃ¡n khoÃ¡ há»c trá»±c tuyáº¿n -> mÃ¬nh táº¡m gá»i lÃ  `course-service`.

- Táº¡o khoÃ¡ há»c má»›i: `POST /courses`
- Láº¥y danh sÃ¡ch toÃ n bá»™ khoÃ¡ há»c: `GET /courses`

### 2.2 - LÃ m sao cáº¥u hÃ¬nh database?

MÃ¬nh sá»­ dá»¥ng Postgres database vÃ  dá»±ng luÃ´n trÃªn AWS thÃ´ng qua AWS RDS. Cá»¥ thá»ƒ cÃ¡c bÆ°á»›c setup mÃ¬nh sáº½ Ä‘á» cáº­p á»Ÿ má»¥c [3.1](/blog/deploy-spring-boot-application-on-aws-code-build-code-pipeline-ecs#31---d%E1%BB%B1ng-postgres-database-aws-rds)

Vá» pháº§n cáº¥u hÃ¬nh, cÃ³ hai Ä‘iá»ƒm cáº§n lÆ°u Ã½:

- CÃ¡c thÃ´ng tin káº¿t ná»‘i Ä‘áº¿n database Ä‘Æ°á»£c mÃ¬nh Ä‘á»ƒ dÆ°á»›i dáº¡ng tham sá»‘ vÃ  truyá»n vÃ o trong quÃ¡ trÃ¬nh runtime Ä‘á»ƒ Ä‘áº£m báº£o viá»‡c báº£o máº­t.

```yml
# ========== Database Configuration ==========
spring.datasource.url=${DB_URL}
spring.datasource.username=${DB_USERNAME}
spring.datasource.password=${DB_PASSWORD}
```

- Sá»­ dá»¥ng liquibase Ä‘á»ƒ quáº£n lÃ½ version cÃ¡c update Ä‘á»‘i vá»›i database.

```yml
spring.liquibase.change-log=classpath:/db/liquibase-changelog.xml
```

### 2.3 - LÃ m sao build vÃ  run á»©ng dá»¥ng á»Ÿ local?

NhÆ° mÃ¬nh Ä‘Ã£ Ä‘á» cáº­p, á»©ng dá»¥ng Ä‘Æ°á»£c triá»ƒn khai á»©ng dá»¥ng dÆ°á»›i dáº¡ng Docker container -> mÃ¬nh cÃ³ táº¡o má»™t file `Dockerfile` cÆ¡ báº£n nhÆ° sau:

```Dockerfile
FROM openjdk:17

WORKDIR /app

COPY ./target/course-service.jar /app

EXPOSE 8090

CMD ["java", "-jar", "course-service.jar"]
```

- Build á»©ng dá»¥ng -> File `.jar`

```shell
mvn clean install -D DB_URL=<database URL> -D DB_USERNAME=<database name> -D DB_PASSWORD=<database password>
```

- Build á»©ng dá»¥ng -> Docker image

```shell
docker build -t  course-service:latest .
```

# 3. - Setup AWS

### 3.1 - Dá»±ng Postgres database (AWS RDS)

- Aurora and RDS -> Databases -> Create database -> PostgresSQL

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_2.png" alt="Alt text" title="image" />
</p>

- Free tier and Single-AZ DB instance deployment (1 instance) -> mÃ¬nh dÃ¹ng free tier cho Ä‘á»¡ máº¥t phÃ­, con nhÃ  nghÃ¨o mÃ  =))

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_3.png" alt="Alt text" title="image" />
</p>

- anh em nháº­p cÃ¡c thÃ´ng tin cáº¥u hÃ¬nh DB instance identifier, master username, password -> nhá»› lÆ°u láº¡i password anh em nhÃ©.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_4.png" alt="Alt text" title="image" />
</p>

- Check `Yes` náº¿u anh em muá»‘n public DB Ä‘á»ƒ bÃªn ngoÃ i internet cÃ³ thá»ƒ connect Ä‘Æ°á»£c.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_5.png" alt="Alt text" title="image" />
</p>

- CÃ¡c thÃ´ng tin khÃ¡c anh em cÃ³ thá»ƒ Ä‘á»ƒ máº·c Ä‘á»‹nh.

=> Váº­y lÃ  setup xong database -> anh em cÃ³ thá»ƒ vÃ o tab `Configuration` Ä‘á»ƒ xem láº¡i cÃ¡c thÃ´ng tin cáº¥u hÃ¬nh.

<p align="center">
  <img src="/static/img/posts/aws-cicd/db_6.png" alt="Alt text" title="image" />
</p>

### 3.2 - Cáº¥u hÃ¬nh Secret Manager

- á» má»¥c 2.2, mÃ¬nh cÃ³ Ä‘á» cáº­p Ä‘áº¿n viá»‡c cÃ¡c tham sá»‘ cáº¥u hÃ¬nh database sáº½ Ä‘Æ°á»£c truyá»n dÆ°á»›i dáº¡ng tham sá»‘ táº¡i thá»i Ä‘iá»ƒm runtime. Váº­y cÃ¡c thÃ´ng tin Ä‘Ã³ Ä‘Æ°á»£c lÆ°u á»Ÿ Ä‘Ã¢u?

=> Trong bÃ i viáº¿t nÃ y, mÃ¬nh sá»­ dá»¥ng AWS Secret Manager Ä‘á»ƒ lÆ°u nhÆ° sau:

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_2.png" alt="Alt text" title="image" />
</p>

Next Ä‘áº¿n step 4 (Review) -> Store

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_3.png" alt="Alt text" title="image" />
</p>

Edit credentials -> thÃªm má»™t biáº¿n lÃ  url trá» Ä‘áº¿n database.

<p align="center">
  <img src="/static/img/posts/aws-cicd/sm_4.png" alt="Alt text" title="image" />
</p>

### 3.3 - Dá»±ng CodeBuild

- CodeBuild -> Build projects -> Create build project

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_1.png" alt="Alt text" title="image" />
</p>

- Chá»n Source provider -> mÃ¬nh chá»n GitHub (vÃ¬ code Ä‘á»ƒ trÃªn GitHub). LÆ°u Ã½, náº¿u cÃ¡c báº¡n chÆ°a káº¿t ná»‘i tá»›i GitHub bao giá» thÃ¬ pháº£i káº¿t ná»‘i trÆ°á»›c -> Chá»n cÃ¡c option nhÆ° bÃªn dÆ°á»›i.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_2.png" alt="Alt text" title="image" />
</p>

- `buildspec.yaml` lÃ  cÃ¡c bÆ°á»›c Ä‘á»ƒ 'hÆ°á»›ng dáº«n' CodeBuild thá»±c hiá»‡n: build project thÃ nh file `.jar` -> build ra Docker image -> Ä‘áº©y Docker image lÃªn ECR.

- CÃ¡c báº¡n cÃ³ thá»ƒ Insert build commands -> Switch to editor -> Paste ná»™i dung file `buildspec.yaml` vÃ o (LÆ¯U Ã: Pháº£i sá»­a láº¡i cÃ¡c thÃ´ng tin cho Ä‘Ãºng vá»›i AWS account báº¡n cáº¥u hÃ¬nh). Hoáº·c check tab `Use a buildspec file` -> sá»­ dá»¥ng file `buildpsec.yaml` táº¡i root folder cá»§a project luÃ´n.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_3.png" alt="Alt text" title="image" />
</p>

- Äá»ƒ CodeBuild cÃ³ thá»ƒ pull image tá»« ECR vÃ  Ä‘á»c cÃ¡c thÃ´ng tin cáº¥u hÃ¬nh database trong file `buildspec.yaml` -> ChÃºng ta pháº£i cáº¥p quyá»n cho role Ä‘Æ°á»£c táº¡o nhÆ° bÃªn dÆ°á»›i.

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_4.png" alt="Alt text" title="image" />
</p>

- Add permissioins -> Attach policies -> Search `AmazonEC2ContainerRegistryFullAccess`, `AmazonEC2ContainerRegistryPowerUser`, `SecretsManagerReadWrite`

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_5.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_6.png" alt="Alt text" title="image" />
</p>

- Báº¥m `Start build` -> Báº¯t Ä‘áº§u quÃ¡ trÃ¬nh build -> Chá»

<p align="center">
  <img src="/static/img/posts/aws-cicd/build_7.png" alt="Alt text" title="image" />
</p>

### 3.4 - Dá»±ng ECR (Elastic Container Registry)

- ECR lÃ  nÆ¡i lÆ°u trá»¯ cÃ¡c images (tÆ°Æ¡ng tá»± nhÆ° DockerHub). Äá»ƒ táº¡o má»™t ECR:

Amazon ECR -> Private Registy -> Repository -> Create Repository

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecr_0.png" alt="Alt text" title="image" />
</p>

Äáº·t tÃªn -> Äá»ƒ máº·c Ä‘á»‹nh cÃ¡c option -> Create

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecr_1.png" alt="Alt text" title="image" />
</p>

### 3.5 - Dá»±ng ECS (cluster, service, task definition)

=> Táº¡o Task Definition:

Amazon Elastic Container Service -> Task definition -> Create new task definition

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_1.png" alt="Alt text" title="image" />
</p>

Chá»n launch type: [AWS Fargate](https://aws.amazon.com/fargate/)

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_2.png" alt="Alt text" title="image" />
</p>

á» má»¥c Task Role -> chá»n ecsTaskExecutionRole

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_4.png" alt="Alt text" title="image" />
</p>

LÆ°u Ã: Do chÃºng ta Ä‘á»c thÃ´ng tin cáº¥u hÃ¬nh tá»« Secret Manager -> CÃ¡c báº¡n attach thÃªm policies lÃ  SecretsManagerReadWrite Ä‘á»ƒ task cÃ³ quyá»n Ä‘á»c thÃ´ng tin tá»« SM.

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_5.png" alt="Alt text" title="image" />
</p>

á» má»¥c Container -> chá»n registry -> chá»n image -> mapping thÃªm port 8090 (vÃ¬ service cáº¥u hÃ¬nh cháº¡y á»Ÿ port 8090)

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_6.png" alt="Alt text" title="image" />
</p>

á» pháº§n biáº¿n mÃ´i trÆ°á»ng (Environment variables) -> cáº¥u hÃ¬nh Ä‘á»ƒ Ä‘á»c cÃ¡c thÃ´ng tin database tá»« Secrets Manager á»Ÿ má»¥c 3.2

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_6_1.png" alt="Alt text" title="image" />
</p>

Váº­y lÃ  táº¡o xong Task definition.

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_7.png" alt="Alt text" title="image" />
</p>

=> Táº¡o Cluster:

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_8.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_9.png" alt="Alt text" title="image" />
</p>

=> Táº¡o Service:

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_10.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_11.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_12.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_13.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/ecs_14.png" alt="Alt text" title="image" />
</p>

### 3.6 - Dá»±ng CodePipeline

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_1_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_2.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_3.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_3_1.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_4.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_5.png" alt="Alt text" title="image" />
</p>

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_6.png" alt="Alt text" title="image" />
</p>

-> Pipeline build ThÃ nh CÃ´ng

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_7.png" alt="Alt text" title="image" />
</p>

-> Pipeline build láº¡i khi cÃ³ code update.

<p align="center">
  <img src="/static/img/posts/aws-cicd/pl_8.png" alt="Alt text" title="image" />
</p>

# 4. - Testing

Sau khi deploy thÃ nh cÃ´ng, cÃ¡c báº¡n truy cáº­p vÃ o Ä‘á»‹a chá»‰: `http://<public IP>/swagger-ui/index.html`. Trong Ä‘Ã³, public IP chÃ­nh lÃ  Ä‘á»‹a chá»‰ IP public Ä‘Æ°á»£c táº¡o ra sau khi chÃºng táº¡o task definition thÃ nh cÃ´ng.

<p align="center">
  <img src="/static/img/posts/aws-cicd/testing_1.png" alt="Alt text" title="image" />
</p>

# 5. - Tá»•ng Káº¿t

Váº­y lÃ  trong bÃ i viáº¿t nÃ y mÃ¬nh Ä‘Ã£ cÃ¹ng anh em tÃ¬m hiá»ƒu cÃ¡ch Ä‘á»ƒ deloy má»™t á»©ng dá»¥ng Spring Boot thá»±c táº¿ cÃ³ káº¿t ná»‘i Ä‘áº¿n database lÃªn mÃ´i trÆ°á»ng Dcoker container thÃ´ng qua AWS ECS, ECR. Äá»“ng thá»i tá»± Ä‘á»™ng hoÃ¡ viá»‡c build vÃ  deploy code sá»­ dá»¥ng AWS CodeBuild, CodePipeline

Háº¹n gáº·p láº¡i anh em trong cÃ¡c bÃ i viáº¿t tiáº¿p theo. Happy Coding!
